name: Deploy to Server

on:
  push:
    branches: [main]
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Deploy via SSH (Docker Container)
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DOCKER_CONTAINER: ${{ secrets.DOCKER_CONTAINER }}
          SITE_NAME: ${{ secrets.SITE_NAME }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euxo pipefail

          echo "ðŸ” Setting up SSH"
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

          echo "ðŸš€ Connecting to server"
          ssh -i ~/.ssh/deploy_key "$DEPLOY_USER@$DEPLOY_HOST" << EOF
            set -euxo pipefail

            echo "ðŸ“ Deployment variables"
            echo "DEPLOY_PATH=$DEPLOY_PATH"
            echo "REF_NAME=$REF_NAME"
            echo "DOCKER_CONTAINER=$DOCKER_CONTAINER"
            echo "SITE_NAME=$SITE_NAME"

            echo "ðŸ“‚ Moving to deploy path"
            cd "$DEPLOY_PATH"

            echo "ðŸ“¦ Checking app directory"
            ls -la apps || true
            ls -la apps/my_awesome_app || true

            echo "ðŸ”„ Fetching latest code"
            cd apps/my_awesome_app
            git fetch origin

            echo "ðŸ”€ Checking out ref: $REF_NAME"
            git checkout "$REF_NAME"

            echo "ðŸ“Š Git status"
            git status
            git log -1 --oneline

            echo "ðŸ³ Verifying Docker container"
            docker ps | grep "$DOCKER_CONTAINER"

            echo "ðŸ§± Running database migrations"
            docker exec "$DOCKER_CONTAINER" bench --site "$SITE_NAME" migrate

            echo "ðŸ“ Syncing DocTypes"
            docker exec "$DOCKER_CONTAINER" bench --site "$SITE_NAME" execute frappe.desk.doctype.doctype.doctype.sync_all

            echo "ðŸ§¹ Clearing cache"
            docker exec "$DOCKER_CONTAINER" bench clear-cache

            echo "ðŸ” Restarting container"
            docker restart "$DOCKER_CONTAINER"

            echo "âœ… Deployment completed successfully"
          EOF